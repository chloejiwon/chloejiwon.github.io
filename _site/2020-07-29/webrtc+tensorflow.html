<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>WebRTC로 실시간 영상 통화를 하며 Object Detection을 해보자 - 1탄 | Tale</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="WebRTC로 실시간 영상 통화를 하며 Object Detection을 해보자 - 1탄" />
<meta name="author" content="Chester How" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="webrtc 와 tensorflow js 모델로 object detection해보기" />
<meta property="og:description" content="webrtc 와 tensorflow js 모델로 object detection해보기" />
<link rel="canonical" href="https://chesterhow.github.io/tale/2020-07-29/webrtc+tensorflow" />
<meta property="og:url" content="https://chesterhow.github.io/tale/2020-07-29/webrtc+tensorflow" />
<meta property="og:site_name" content="Tale" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-29T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="WebRTC로 실시간 영상 통화를 하며 Object Detection을 해보자 - 1탄" />
<script type="application/ld+json">
{"url":"https://chesterhow.github.io/tale/2020-07-29/webrtc+tensorflow","mainEntityOfPage":{"@type":"WebPage","@id":"https://chesterhow.github.io/tale/2020-07-29/webrtc+tensorflow"},"author":{"@type":"Person","name":"Chester How"},"description":"webrtc 와 tensorflow js 모델로 object detection해보기","@type":"BlogPosting","headline":"WebRTC로 실시간 영상 통화를 하며 Object Detection을 해보자 - 1탄","dateModified":"2020-07-26T15:11:00+09:00","datePublished":"2020-07-29T00:00:00+09:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- CSS -->
  <link rel="stylesheet" href="/tale/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/tale/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/tale/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/tale/assets/apple-touch-icon.png">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="https://chesterhow.github.io/tale/feed.xml" title="Tale" />

  <!-- Google Analytics-->
  
</head>


  <body>

    <nav class="nav">
  <div class="nav-container">
    <a href="/tale/">
      <h2 class="nav-title">Tale</h2>
    </a>
    <ul>
      <li><a href="/tale/">Posts</a></li>
      <li><a href="/tale/tags">Tags</a></li>
      <li><a href="/tale/about">About</a></li>
    </ul>
  </div>
</nav>


    <main>
      <div class="post">
  <div class="post-info">
    <span>Written by</span>
    
        Chester How
    

    
      <br>
      <span>on&nbsp;</span><time datetime="2020-07-29 00:00:00 +0900">July 29, 2020</time>
    
  </div>

  <h1 class="post-title">WebRTC로 실시간 영상 통화를 하며 Object Detection을 해보자 - 1탄</h1>
  <div class="post-line"></div>

  <blockquote>
  <p>프로젝트 진행하면서 처음 접한 webrtc.. 실시간으로 영상 채팅하며tensorflow js 모델과 함께 객체 인식을 하는 기능을 구현해보는데… 👀</p>

  <p>왕왕 초보라 틀린 정보가 있을 수 있음을 미리 고지합니다</p>
</blockquote>

<h1 id="-table-of-contents">📌 Table of Contents</h1>

<ul>
  <li><a href="#webrtc가-뭐냐">WebRTC가 뭐냐?</a>
    <ul>
      <li><a href="#webrtc-동작방식">webrtc 동작방식</a></li>
    </ul>
  </li>
  <li><a href="#webrtc-구현하기">WebRTC구현하기</a>
    <ul>
      <li><a href="#N:N영상통화">N:N영상통화</a></li>
    </ul>
  </li>
  <li><a href="#reference">reference</a></li>
</ul>

<h1 id="webrtc가-뭐냐">webRTC가 뭐냐?</h1>

<p>WebRTC는 web application간에 실시간 통신 기능을 제공하는 기술. 특히 마이크나 스피커, 영상같은 데이터를 실시간으로 peer connection으로 별도 서버 없이 가능하게 해준다.  (심지어 screen sharing도 가능하다고 함 ) 그럼 간단한 동작 방식을 살펴보자!</p>

<h2 id="webrtc-동작-방식">webRTC 동작 방식</h2>

<p><img src="https://webrtc-security.github.io/images/diagram_1_en.png" alt="webrtc-topology" /></p>

<p>아주아주 간단한 webrtc topology는 위와 같다. Alice와 Bob이 각자 컴퓨터에서 browser를 키면, signaling server에 signal을 전송한다. Signaling은 RTCPeerConnection들이 적절하게 데이터를 교환할 수 있게 처리하는 복잡한 과정이다. Signaling server는 피어와 피어가 서로를 찾을 수 있도록 도와주는 서버. Signaling 단계에선 서로 Connection을 맺기 이전 아래와 같은 정보를 교환하도록 해줍니다.</p>

<ol>
  <li>Network 정보 교환
    <ol>
      <li>P2P 통신을 위해선 연결을 위한 각 client가 서로의 IP와 UDP port,  따위의 것을 알고 있어야 한다. WebRTC communication이 동작하기 전에 이 과정이 미리 되어 있어야 하는데, 이때 쓰이는 서버가 <strong>STUN</strong> 서버이다.  STUN서버로 인해 서로 각client가 자기 IP를 알게 된다.</li>
    </ol>
  </li>
  <li>Media Capability 교환</li>
  <li>Session Control Message 교환</li>
</ol>

<p>결국 시그널링을 통해 정보를 주고 받고 P2P connection을 맺는다. 그리고 그 후부턴 각 peer 로 각자의 media, data를 전송하면 된다. 👏🏻</p>

<h1 id="webrtc-구현하기">webRTC 구현하기</h1>

<p>프로젝트에서 사용한 기본적인 뼈대 코드를 webRTC 엄청 고수로 추정되는 유투버가 제공하는 tutorial 로 구현한 부분을 공유해본다. simple peer를 이용하여 아주 간단한 예제를 학습해봤다.</p>

<p>코드 전문은 여기서 확인 가능하다. 😎 (여기서 signaling server는 server.js)</p>

<p><a href="https://github.com/chloejiwon/coronabusters/tree/webrtc_basic_tutorial">https://github.com/chloejiwon/coronabusters/tree/webrtc_basic_tutorial</a></p>

<h2 id="nn-영상통화">N:N 영상통화</h2>

<p>동작 Flow부터 먼저 확인하자.</p>

<ol>
  <li>client A가 브라우저에 접속하여, signaling server에 connection을 알린다.</li>
  <li>clinet B가 브라우저에 접속하여 signaling server에 알린다. 엇 근데 기다리는 client A가 있네? signaling server는 A의 socket 정보를 B에 보낸다.</li>
  <li>A의 정보를 받은 B는 A에 대해  createPeer 을 한다. 그리고 B의 peer signal를 signaling server에 전송한다.</li>
  <li>signaling server에서는 B의 signal을 A에게 전송한다. A또한 peer을 만들고, A의 signal을 signaling server에 전송하고, peer에도 signal한다.</li>
  <li>B가 signaling server에서 정보 받으면, A에게 signal한다. (이제 P2P연결이 맺어진 것. 각 peer로 data, media stream을 주고받을 수 있다.)</li>
</ol>

<p>내가 github에 구현해놓은 부분은 N:N 다대다 통신이다. 당연히 p2p 니까, 얘네는 모두가 모두랑 연결되어 있으면 되는거다. Client 한 명이 방에 들어오면 방에 있는 모든 친구들의 socket id 리스트를 보내준다. 그럼 새로 방에 들어온 client가 각 친구들에게 signal을 보내 peer connection을 맺는다. 모두가 모두랑 연결되어 있으므로 N명이 있다면 전체 connection의 갯수는 N*(N-1)/2 이다. (친구를 그래프의 노드라고 생각하면 연결할 수 있는 모든 간선의 수) 여기까지 하면 아주 간단하게 친구의 stream을 얻어와 서로 데이터 공유할 수 있다. 🎉</p>

<p>root 폴더에서 아래 명렁어로 signaling server를 띄우고, (8000 포트 아무도 쓰지 않아야 함, 아님 설정을 바꿔주든지..?)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$node server.js
</code></pre></div></div>

<p>client/ 폴더에서는 view를 위해 아래 command 입력한다. (이건 3000번 포트 사용한다)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$npm run-script start
</code></pre></div></div>

<p>혹시 무슨 tensorflow coco-ssd 못 불러온다는 에러가 뜨면 아래 명령어 입력한다.</p>

<p>왜 package.json에 있는데 install 따로 해줘야할까..? 😞</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ npm install @tensorflow-models/coco-ssd
$ npm install @tensorflow/tfjs
</code></pre></div></div>

<p>하여튼 이렇게 하면 <code class="language-plaintext highlighter-rouge">http://location:3000</code>에 접속하면 create room화면이 뜨고, 누르면 자기 얼굴이 턱 등장.</p>

<p>이제 나는 자기 비디오에 Tensorflow js 모델을 통해 object detection을 하고자 하는데 이거는 다음 편에 이어서 마무리하도록 하겠다. 🤟🏼</p>

<h1 id="reference">reference</h1>

<ul>
  <li><a href="http://jaynewho.com/post/36">http://jaynewho.com/post/36</a></li>
  <li><a href="http://webrtc.org">http://webrtc.org</a></li>
  <li><a href="https://www.youtube.com/watch?v=R1sfHPwEH7A">https://www.youtube.com/watch?v=R1sfHPwEH7A</a></li>
</ul>


</div>



<div class="pagination">
  
    <a href="/tale/2020-08-09/ibm-clouders-notetaking" class="left arrow">&#8592;</a>
  
  
    <a href="/tale/2020-05-30/matrix-factorization" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>
    </main>

    <footer>
  <span>
    &copy; <time datetime="2021-02-19 20:56:09 +0900">2021</time> Chester How. Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
  </span>
</footer>

  </body>
</html>
